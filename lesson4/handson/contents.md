## はじめに

このレッスンでは、Supabase Authenticationを使用した認証機能付きダッシュボードアプリケーションを構築します。メール+パスワードによるサインアップ/ログイン/ログアウト機能、middlewareによるセッション管理、設定ファイルベースのエラーメッセージ管理システムを実装し、本格的なWebアプリケーションの認証基盤を学習します。

完成形は以下の4ページで構成されます：
- `/` - パブリックページ（アプリ説明とログインリンク）
- `/login` - ログインページ（メール・パスワードでログイン）
- `/signup` - サインアップページ（新規アカウント作成）
- `/dashboard` - 保護ページ（認証済みユーザー専用）

## 対象者

- Reactを理解している
- Next.jsの基本（App Router、page.js / layout.js）を理解している
- Supabaseを使ったことがない、または軽く触れた程度

## 目的

1. 認証（Authentication）と認可（Authorization）の違いを理解する
2. Supabase Authenticationを用いてメール+パスワードのサインアップ/ログイン/ログアウトを実装する
3. Next.jsのmiddlewareでセッションを更新しつつ、未認証ユーザーをログインページへリダイレクトする方法を学ぶ
4. 設定ファイルベースのエラーメッセージ管理システムを構築する
5. Client ComponentでのエラーハンドリングとUI状態管理を実装する

## 学習対象のスキル

- Supabase Authentication（email/password）
- @supabase/ssrとcookiesを用いたSSR連携
- middlewareによるセッション更新と楽観的チェック
- サーバーコンポーネントでの`redirect`と厳密ガード（`supabase.auth.getUser`）
- `cookies`（非同期API）の取り扱い
- `NextResponse.redirect`
- 設定ファイルベースのエラーメッセージ管理
- Client Componentでの状態管理（useState、useRouter）
- エラーハンドリングとローディング状態のUI実装

## 前提（推奨）

- Node.js LTS（18.17.0以上）
- npm または yarn
- 基本的なTypeScriptの知識
- Gitの基本操作

### Supabaseの新規作成が必要

このレッスンではSupabase CLIを使用してローカル開発環境を構築します。以下の手順でSupabaseプロジェクトを作成してください：

1. Supabase CLIのインストール
2. `supabase init`でプロジェクトを初期化
3. `supabase start`でローカル環境を起動
4. 環境変数の設定

## 環境変数（.env）例：

```
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
```

## 主要ページ・ルート

- `/` - パブリックページ
- `/login` - ログインページ
- `/signup` - サインアップページ
- `/dashboard` - 保護ページ
- `src/lib/actions.ts` - Server Actions
- `src/lib/supabase/` - Supabaseクライアント設定
- `src/lib/error-messages.ts` - エラーメッセージ管理ユーティリティ
- `src/config/error-messages.json` - エラーメッセージ設定

## 注意

- 認証が必要なページはmiddlewareで保護される
- エラーメッセージは設定ファイルで管理される
- Client Componentでは適切な状態管理が必要
- セキュリティのため、環境変数は適切に管理する

---

## 章立て（目次）

1. `01-環境構築.md`
   - 新規Next.jsプロジェクトの作成とSupabase CLIのセットアップ

2. `02-共通レイアウト.md`
   - ヘッダーとフッターコンポーネントの作成

3. `03-認証機能の実装.md`
   - 型定義、Supabaseクライアント（サーバー・クライアント）、Server Actions、エラーメッセージ管理システム、ログインページ、認証チェック機能の実装

4. `04-ダッシュボードページ.md`
   - 保護ページの実装とmiddlewareの設定

5. `05-まとめ.md`
   - 学習内容の整理と確認

各章のMarkdownは、次の見出しルールで統一されています。

- 章タイトルは不要（先頭はH2から）。
- 本文のH2は「はじめに」「目的」「学習対象のスキル」「課題A/B/C」「章末の確認」に限定する（その他のH2は置かない）。
- 見出し構成の雛形（例：はじめに／目的／学習対象のスキル／課題群／章末の確認）。
- タイプAの各課題見出し直下には導入定型文「X分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。」を厳密一致で記載（Xは見出しの分数と一致）。
- 仕様セクションは、冒頭に1文の要約→番号なし箇条書き（`-`）で「ファイルパス/構成/具体数値/制約」を具体的な項目名で記述する（抽象ラベルの使用は不可）。
- 「【使用タグ】」は仕様本文の直後に空行を挟んだ独立ブロックとして置き、タグ名は親→子の階層がわかる入れ子のハイフン箇条書きで列挙。「完了条件」「ヒント」などは混在させない）。
- API章の「章末の確認」では、curlコマンドに`-i`を付けHTTPステータスとレスポンスヘッダーも確認できるようにする。
- UI課題の仕様本文では、次のようなラベル付き箇条書きのグルーピング（例:「構造:」「入力要素の属性:」「スタイル:」「振る舞い:」）を1つずつハイフン行として並べ、その下に入れ子の詳細箇条書きを置く形式も許容する（見出しではなく通常の箇条書きラベルであること）。
- UI+振る舞い/UI+API混在課題では、以下の共通テンプレート順序（または下記ラベルの一部省略）を推奨する。各行は見出しではなく1つのハイフン箇条書きとし、必要なら下位入れ子で詳細を記述する。
  - 対象ファイル:
  - 構造:
    -（タグ階層・並び）
  - 入力要素の属性:
  - スタイル:
  - 振る舞い（今回実装分）:
  - 送信先:（API課題時）
  - リクエスト仕様:（API課題時、method / headers / body）
  - エラー処理:（API課題時）
  - 成功時処理:（API課題時）
  - 最終処理:（API課題時 / finallyで行うもの）
  - 除外（今回未実装）:（次章以降で扱う項目を明示的に列挙する任意枠）
- 上記テンプレのラベル語尾にコロンを付ける（例:「構造:」）。ラベルそのものをH3等の見出しに昇格させない。

---

## 進め方と検証方針

- 各章の課題を順番に実装する
- 実装後はブラウザで動作確認を行う
- エラーメッセージの翻訳が正しく表示されることを確認する
- ログイン・ログアウトの流れが正常に動作することを確認する
- 未認証ユーザーが保護ページにアクセスした際のリダイレクトを確認する

## 注意

- 環境変数は適切に設定し、公開リポジトリにコミットしない
- エラーメッセージの設定ファイルは適切に管理する
- 認証状態の管理は慎重に行う
- セキュリティを考慮した実装を心がける
