## はじめに

Supabase Authenticationを使用した認証機能を実装します。型定義、Server Actions、ログインページを作成し、メール+パスワードでのサインアップとログイン機能を構築します。

## 目的

- 認証関連の型定義の作成
- Supabaseクライアントの設定
- Server Actionsによる認証処理の実装
- ログインページの作成

## 学習対象のスキル

- TypeScriptの型定義
- Supabase Authentication API
- Server Actionsの実装
- フォーム処理とエラーハンドリング

## 課題A：型定義の作成（5分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

認証機能で使用する型定義を作成します。

- 作成するファイル: `src/types/auth.ts`
- 認証フォームデータ: メールアドレスとパスワードの文字列
- 認証エラー: エラーメッセージの文字列
- ユーザー情報: IDとメールアドレスの文字列

【使用タグ】
- `interface`（型定義）
  - `AuthFormData`
  - `AuthError`
  - `User`

### ヒント

- TypeScriptの`interface`を使用
- 各プロパティの型を明示的に指定

### 解答例

```typescript
export interface AuthFormData {
  email: string;
  password: string;
}

export interface AuthError {
  message: string;
}

export interface User {
  id: string;
  email: string;
}
```

## 課題B：Supabaseクライアントの設定（8分）

8分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

サーバーサイドで使用するSupabaseクライアントを作成します。

- 作成するファイル: `src/lib/supabase/server.ts`
- 環境変数: `NEXT_PUBLIC_SUPABASE_URL`と`NEXT_PUBLIC_SUPABASE_ANON_KEY`を使用
- cookies管理: `next/headers`の`cookies`を使用
- エラーハンドリング: `setAll`でエラーが発生した場合は無視

【使用タグ】
- `createServerClient`（Supabaseクライアント作成）
- `cookies`（Next.jsのcookies管理）

### ヒント

- `@supabase/ssr`の`createServerClient`を使用
- cookiesの`getAll`と`setAll`メソッドを実装
- 環境変数は`process.env`から取得

### 解答例

```typescript
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  );
}
```

## 課題C：Server Actionsの実装（12分）

12分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

認証処理を行うServer Actionsを作成します。

- 作成するファイル: `src/lib/actions.ts`
- サインアップ機能: メールとパスワードで新規登録
- ログイン機能: メールとパスワードでログイン
- ログアウト機能: セッションを終了
- エラーハンドリング: 認証エラーを返却
- リダイレクト: 成功時に適切なページへ遷移

【使用タグ】
- `signUp`（サインアップ関数）
- `signIn`（ログイン関数）
- `signOut`（ログアウト関数）

### ヒント

- `"use server"`ディレクティブを追加
- `revalidatePath`でキャッシュを更新
- `redirect`でページ遷移
- エラー時は`AuthError`型で返却

### 解答例

```typescript
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";
import { AuthFormData, AuthError } from "@/types/auth";

export async function signUp(
  formData: AuthFormData
): Promise<AuthError | null> {
  const supabase = await createClient();

  const { error } = await supabase.auth.signUp({
    email: formData.email,
    password: formData.password,
  });

  if (error) {
    return { message: error.message };
  }

  revalidatePath("/", "layout");
  redirect("/dashboard");
}

export async function signIn(
  formData: AuthFormData
): Promise<AuthError | null> {
  const supabase = await createClient();

  const { error } = await supabase.auth.signInWithPassword({
    email: formData.email,
    password: formData.password,
  });

  if (error) {
    return { message: error.message };
  }

  revalidatePath("/", "layout");
  redirect("/dashboard");
}

export async function signOut() {
  const supabase = await createClient();

  await supabase.auth.signOut();

  revalidatePath("/", "layout");
  redirect("/");
}
```

## 課題D：ログインページの作成（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

ログインとサインアップのフォームを持つページを作成します。

- 作成するファイル: `src/app/login/page.tsx`
- ページタイトル: 「アカウントにログイン」
- フォーム要素: メールアドレスとパスワードの入力フィールド
- ボタン: 「ログイン」と「サインアップ」の2つ
- レイアウト: 中央揃え、最大幅`max-w-md`
- バリデーション: 必須入力、メール形式

【使用タグ】
- `div`（最上位コンテナー）
  - `div`（フォームラッパー）
    - `div`（ヘッダー）
      - `h2`（ページタイトル）
      - `p`（説明文）
    - `form`（フォーム）
      - `div`（入力フィールド）
        - `input`（メール入力）
        - `input`（パスワード入力）
      - `div`（ボタンエリア）
        - `button`（ログインボタン）
        - `button`（サインアップボタン）

### ヒント

- Tailwindの例：`min-h-screen` `flex` `items-center` `justify-center` `max-w-md` `space-y-8`
- `formAction`でServer Actionsを呼び出し
- アクセシビリティのため`label`を追加

### 解答例

```tsx
import { signIn, signUp } from "@/lib/actions";
import { AuthFormData } from "@/types/auth";

export default function LoginPage() {
  async function handleSignIn(formData: FormData) {
    "use server";

    const data: AuthFormData = {
      email: formData.get("email") as string,
      password: formData.get("password") as string,
    };

    const error = await signIn(data);
    if (error) {
      // エラーハンドリングは簡略化
      console.error("Sign in error:", error.message);
    }
  }

  async function handleSignUp(formData: FormData) {
    "use server";

    const data: AuthFormData = {
      email: formData.get("email") as string,
      password: formData.get("password") as string,
    };

    const error = await signUp(data);
    if (error) {
      // エラーハンドリングは簡略化
      console.error("Sign up error:", error.message);
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            アカウントにログイン
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            または新しいアカウントを作成
          </p>
        </div>
        <form className="mt-8 space-y-6">
          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="email" className="sr-only">
                メールアドレス
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="メールアドレス"
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                パスワード
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="パスワード"
              />
            </div>
          </div>

          <div className="flex space-x-4">
            <button
              formAction={handleSignIn}
              type="submit"
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              ログイン
            </button>
            <button
              formAction={handleSignUp}
              type="submit"
              className="group relative w-full flex justify-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              サインアップ
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

## 章末の確認

- 型定義が正しく作成されている
- Supabaseクライアントがサーバーサイドで動作する
- Server Actionsで認証処理が実行される
- ログインページでフォーム送信ができる
