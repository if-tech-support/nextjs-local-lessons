## はじめに

この章では、Next.jsの`next/image`コンポーネントを使って最適化された画像表示を行います。外部画像の表示、レスポンシブ対応、パフォーマンス向上を実現しましょう。

## 目的

`next/image`で外部画像を最適化して表示する。

## 学習対象のスキル

- `next/image`コンポーネントの使用方法
- 画像の最適化とレスポンシブ対応
- UIの改善とユーザビリティの向上

## 課題A：ユーザ一覧ページへのアバター画像の追加（20分）

20分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`src/app/users/page.tsx` を編集し、ユーザ一覧に最適化画像を組み込みます。

1. ページはサーバーコンポーネント（`async`）でユーザ一覧を取得する（既存fetch関数を保持）。
2. 各ユーザカード先頭にアバター画像を表示する。
3. 画像ソースは `https://robohash.org/{ユーザID}`（ユーザIDを文字列連結）。
4. 一覧のアバター画像表示サイズは64px×64px（ラッパ要素幅/高さ64px、円形）。
5. 親要素は相対配置とし、`next/image` の `fill` を用いて画像を親内に完全に収める。
6. 画像の `alt` テキストは「{username}のアバター」。
7. リストはグリッドレイアウト（中画面2列 / 大画面3列）を維持し余計なラッパーを追加しない。
8. カード内ユーザ名は `username` を表示し、既存テキスト/クラスを変更しない。
9. フォールバックやプレースホルダー独自挙動はこの課題では追加しない（差分最小）。
10. 既存のボタン/リンク/クラス構成を改変しない。

【使用タグ】
- `<div>` 最上位
  - `<h1>` 見出し
  - `<ul>` 一覧
    - `<li>` カード
      - `<div>` ヘッダー行
        - `<div>` 画像ラッパ
          - `<Image>` アバター画像
        - `<div>` テキストブロック
          - `<p>` ID
          - `<h3>` ユーザ名
      - `<div>` 会社情報ラッパ
        - `<p>` 会社名
      - `<Link>` 詳細遷移リンク

### ヒント

Tailwindの例：`rounded-full` `overflow-hidden` `object-cover` `grid`

- `next/image` の `fill` と親 `relative` でサイズ固定。
- 円形はラッパに `rounded-full overflow-hidden` を適用。
- altはusernameを使用して動的文字列化。
- 既存クラス（グリッド列、余白、影）に変更を加えない。

### 解答例

```tsx
import Image from "next/image";
import Link from "next/link";
import { User } from "@/types/user";

// ユーザデータを取得する関数
async function getUsers(): Promise<User[]> {
  const response = await fetch("https://jsonplaceholder.typicode.com/users");

  if (!response.ok) {
    throw new Error("Failed to fetch users");
  }

  return response.json();
}

export default async function UsersPage() {
  const users = await getUsers();

  return (
    <div>
      <h1 className="text-3xl font-bold mb-8 text-gray-800">ユーザ一覧</h1>

      <ul className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {users.map((user) => (
          <li
            key={user.id}
            className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
          >
            <div className="flex items-center space-x-4 mb-4">
              <div className="relative w-16 h-16 rounded-full overflow-hidden">
                <Image
                  src={`https://robohash.org/${user.id}`}
                  alt={`${user.username}のアバター`}
                  fill
                  className="object-cover"
                  sizes="64px"
                />
              </div>
              <div>
                <p className="text-sm text-gray-500">ID: {user.id}</p>
                <h3 className="font-semibold text-lg text-gray-800">
                  {user.username}
                </h3>
              </div>
            </div>

            <div className="mb-4">
              <p className="text-gray-600 mb-2">
                <span className="font-medium">会社:</span> {user.company.name}
              </p>
            </div>

            <Link
              href={`/users/${user.id}`}
              className="inline-block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
            >
              詳細を見る
            </Link>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### 実装ポイント

- サーバーサイド取得で初回表示を完了させる。
- `fill` + ラッパサイズ固定で不要なレイアウトシフトを防ぐ。
- 画像サイズ縮小（64px）により一覧の可視情報密度を最適化。
- クラス例は既存構造を踏襲し最低限の追加に留める（差分最小）。

## 課題B：ユーザ詳細ページの画像最適化確認（15分）

15分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`src/app/users/[id]/page.tsx` を編集し、詳細ページでも最適化画像を適用します。

1. 戻るボタン（既存）直後に見出しが続く構造を維持する。
2. 見出し下にユーザヘッダー行（アバター + 基本情報）を配置。
3. アバター画像は128px×128px（ラッパは幅128px・高さ128pxの円形）。
4. 画像ソースは `https://robohash.org/{ユーザID}`。
5. 画像は `fill` を用い、親要素は相対配置とし、内容のはみ出しを隠し、円形にする。
6. `alt` は `{username}のアバター`。
7. 連絡先 / 会社情報 / 住所の3ブロック構造（上2ブロックに下罫線）を保持。
8. 既存クラス名・文言を変更せず差分ゼロ。

【使用タグ】
- `<div>` 最上位
  - `<div>` 戻るボタンラッパ
    - `<BackButton>` 戻るボタン
  - `<h1>` 見出し
  - `<div>` 詳細カード
    - `<div>` ヘッダー行
      - `<div>` 画像ラッパ
        - `<Image>` アバター
      - `<div>` 基本情報
        - `<h2>` ユーザ名
        - `<p>` 本名
    - `<div>` 情報集合
      - `<div>` 連絡先情報
        - `<h3>` 見出し
        - `<p>` メール
        - `<p>` 電話
        - `<p>` ウェブサイト
      - `<div>` 会社情報
        - `<h3>` 見出し
        - `<p>` 会社名
        - `<p>` キャッチフレーズ
      - `<div>` 住所
        - `<h3>` 見出し
        - `<p>` 通り/スイート
        - `<p>` 市区/郵便番号

### ヒント

Tailwindの例：`w-32` `h-32` `rounded-full` `overflow-hidden` `object-cover`

- 128px画像は `sizes="128px"` を指定し明示的ヒント。
- レイアウトは既存flex+間隔クラスを再利用。
- alt内usernameは大文字小文字/表記を実データそのまま使用。

### 解答例

```tsx
import Image from "next/image";
import { notFound } from "next/navigation";
import { User } from "@/types/user";
import BackButton from "./BackButton";

// 特定のユーザデータを取得する関数
async function getUser(id: string): Promise<User> {
  const response = await fetch(
    `https://jsonplaceholder.typicode.com/users/${id}`
  );

  if (!response.ok) {
    throw new Error("Failed to fetch user");
  }

  return response.json();
}

interface UserDetailPageProps {
  params: {
    id: string;
  };
}

export default async function UserDetailPage({ params }: UserDetailPageProps) {
  try {
    const user = await getUser(params.id);

    return (
      <div>
        <div className="mb-6">
          <BackButton />
        </div>

        <h1 className="text-3xl font-bold mb-8 text-gray-800">ユーザ詳細</h1>

        <div className="bg-white rounded-lg shadow-lg p-8 max-w-2xl">
          <div className="flex items-center space-x-6 mb-8">
            <div className="relative w-32 h-32 rounded-full overflow-hidden">
              <Image
                src={`https://robohash.org/${user.id}`}
                alt={`${user.username}のアバター`}
                fill
                className="object-cover"
                sizes="128px"
              />
            </div>
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-2">
                {user.username}
              </h2>
              <p className="text-gray-600">{user.name}</p>
            </div>
          </div>

          <div className="space-y-4">
            <div className="border-b pb-4">
              <h3 className="font-semibold text-gray-700 mb-2">連絡先情報</h3>
              <p className="text-gray-600">
                <span className="font-medium">メール:</span> {user.email}
              </p>
              <p className="text-gray-600">
                <span className="font-medium">電話:</span> {user.phone}
              </p>
              <p className="text-gray-600">
                <span className="font-medium">ウェブサイト:</span>{" "}
                <a
                  href={user.website}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-600 hover:underline"
                >
                  {user.website}
                </a>
              </p>
            </div>

            <div className="border-b pb-4">
              <h3 className="font-semibold text-gray-700 mb-2">会社情報</h3>
              <p className="text-gray-600">
                <span className="font-medium">会社名:</span> {user.company.name}
              </p>
              <p className="text-gray-600">
                <span className="font-medium">キャッチフレーズ:</span>{" "}
                {user.company.catchPhrase}
              </p>
            </div>

            <div>
              <h3 className="font-semibold text-gray-700 mb-2">住所</h3>
              <p className="text-gray-600">
                {user.address.street}, {user.address.suite}
              </p>
              <p className="text-gray-600">
                {user.address.city}, {user.address.zipcode}
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  } catch {
    notFound();
  }
}
```

### 実装ポイント

- 一覧と同様に `fill` + ラッパサイズ固定で最適化。
- 連絡先/会社/住所ブロックの下罫線/余白構造を維持し差分なし。
- `username` と `name` の両値を役割分離（表示名/フルネーム）。

## 課題C：next.config.tsでの画像最適化設定確認（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`L2/next.config.ts` を編集して外部画像最適化設定を確認します。

1. `images.remotePatterns` に `robohash.org` のみを許可（必要最小）。
2. プロトコルは `https`、パスは `/**`、ポート空欄を維持。
3. 不要な追加ドメインを増やさない。

【使用タグ】（設定対象キー）
- `images`
  - `remotePatterns`
    - `protocol`
    - `hostname`
    - `port`
    - `pathname`

### ヒント

- 利用する外部画像ホストを最小化すると攻撃面が減る。
- 追加が必要になるまで他ホストは登録しない。

### 解答例

```ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "robohash.org",
        port: "",
        pathname: "/**",
      },
    ],
  },
};

export default nextConfig;
```

### 実装ポイント

- 最小構成により不要な外部リクエストを抑制。
- 将来追加が必要な際は課題化して差分を明示。

## 章末の確認

以下の手順で動作確認を行ってください：

1. 開発サーバーを再起動（設定変更のため）。
```bash
npm run dev
```

2. ブラウザで`http://localhost:3000/users`にアクセス。

3. 確認項目
- 一覧ページの各カードに64px円形アバターが表示される。
- 詳細ページのアバターは128px円形で表示される。
- 一覧/詳細とも `alt` が `{username}のアバター` 形式になっている。
- next.config.tsに`robohash.org`のみ設定されている。
- レイアウト崩れや不要なラッパー追加がない。
