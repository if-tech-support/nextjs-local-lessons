## はじめに

DBスキーマの作成と、サーバー側で使うSupabaseクライアント/型/URLユーティリティを用意します。以降のAPI実装の前提をここで整えます。

## 目的

- `public.memos`テーブルを作成できる。
- サーバー側で使うSupabaseクライアント生成関数を用意できる。
- APIフルURL生成関数（`apiUrl`）と`Memo`型を定義できる。

## 学習対象のスキル

- SQLによるテーブル作成。
- Supabaseクライアント初期化（SSR用。`next/headers`の`cookies()`でCookieを扱う）。
- ユーティリティ関数/型定義の分割。

## 課題A：DBスキーマを作る（5分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様
SupabaseのSQLエディターで拡張を有効化し、メモ保存用のテーブルを作成します。

- 実行場所: SupabaseのSQLエディター（ローカル保存は任意）。
- テーブル: `public.memos`
- カラム定義:
  - `id`: `uuid`、主キー、デフォルトは`gen_random_uuid()`。
  - `title`: `text`、必須。
  - `content`: `text`、必須。
  - `created_at`: `timestamptz`、必須、デフォルトは現在時刻。
  - `updated_at`: `timestamptz`、必須、デフォルトは現在時刻。
- 拡張機能: `pgcrypto` を有効化する。
- 注意: カラム名や型は変更しない。

【使用タグ】
- （該当なし）

### ヒント

Tailwindの例：`text-sm` `font-mono` `p-2`

### 解答例

```sql
-- Enable required extension for gen_random_uuid
create extension if not exists pgcrypto;

-- Memos table
create table if not exists public.memos (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  content text not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

```

## 課題B：Supabaseクライアントと補助モジュール/型を用意する（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様
SSRで利用するSupabaseクライアントと、API URLユーティリティ、メモ用の型を用意します。

- 作成するファイル: `src/utils/server.ts`、`src/lib/api.ts`、`src/types/memo.ts`
- クライアント生成:
  - ライブラリは`@supabase/ssr`を使い、`createServerClient`で生成する。
  - 関数名は`createClient`（async）とし、`next/headers`の`cookies()`から取得したCookieを`getAll`/`setAll`で渡す。
  - 環境変数は`NEXT_PUBLIC_SUPABASE_URL`と`NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`を使用する。
- APIユーティリティ:
  - `apiUrl(path)`を実装し、`NEXT_PUBLIC_BASE_URL`を先頭に付与する。
  - 末尾のスラッシュが重ならないように調整する。
- 型定義:
  - `Memo`、`MemoCreateInput`、`MemoUpdateInput`を定義する。
- 注意:
  - 余計なラッパー関数やクラスは追加しない。
  - ベースURLを直書きしない。

【使用タグ】
- （該当なし）

### ヒント

Tailwindの例：`text-sm` `font-mono` `p-2`

### 解答例

```ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  );
}

```

```ts
// APIエンドポイントのフルURLを生成するユーティリティ
// NEXT_PUBLIC_BASE_URL を先頭に付与し、二重スラッシュを避けます
const BASE = (process.env.NEXT_PUBLIC_BASE_URL || '').replace(/\/$/, '');

export function apiUrl(path: string) {
  const p = path.startsWith('/') ? path : `/${path}`;
  return `${BASE}${p}`;
}

```

```ts
export type Memo = {
  id: string;
  title: string;
  content: string;
  created_at: string; // ISO string
  updated_at: string; // ISO string
};

export type MemoCreateInput = {
  title: string;
  content: string;
};

export type MemoUpdateInput = Partial<MemoCreateInput>;

```

## 章末の確認

- SupabaseのSQLで`public.memos`テーブルが作成されている。
- `src/utils/server.ts`にクライアント生成関数（`createClient`）がある。
- `src/lib/api.ts`と`src/types/memo.ts`が作成されている。
