## はじめに

DBスキーマの作成と、サーバー側で使うSupabaseクライアント/型/URLユーティリティを用意します。以降のAPI実装の前提をここで整えます。

## 目的

- `memos`テーブル（スキーマ: `public`）を作成できる。
- サーバー側で使うSupabaseクライアント生成関数を用意できる。
- APIフルURL生成関数（`apiUrl`）と`Memo`型を定義できる。

## 学習対象のスキル

- SQLによるテーブル作成。
- Supabaseクライアント初期化（SSR用。`next/headers`の`cookies()`でCookieを扱う）。
- ユーティリティ関数/型定義の分割。

## 課題A：DBスキーマを作る（5分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様
SQLファイル（`supabase/schema.sql`）を作成し、その内容をSupabaseに適用してメモ保存用のテーブルを用意します。

- 作成するファイル: `supabase/schema.sql`
- 適用方法: 上記ファイルの内容をSupabaseのSQLエディターに貼り付けて実行する（CLIは不要）
- テーブル: `memos`（スキーマ: `public`）
- カラム定義:
  - `id`: `uuid`、主キー、デフォルトは`gen_random_uuid()`
  - `title`: `text`、必須
  - `content`: `text`、必須
  - `created_at`: `timestamptz`、必須、デフォルトは現在時刻
  - `updated_at`: `timestamptz`、必須、デフォルトは現在時刻
- 注意: カラム名や型は変更しない

【使用タグ】
- （該当なし）

### ヒント

- Supabaseダッシュボードの「SQLエディター」を開き、`supabase/schema.sql`の内容を貼り付けて実行します。
- `pgcrypto`拡張はSupabase環境で既定で有効な場合が多いです。本章のSQLには記述不要です。必要時のみ個別に有効化してください。
- `create table if not exists ...` により再実行しても安全です（定義の変更は行わない）。
- スキーマは `public` のままにします。

### 解答例

```sql
create table memos (
  id uuid default gen_random_uuid() primary key,
  title text not null,
  content text not null,
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null
);
```

## 課題B：Supabaseクライアントと補助モジュール/型を用意する（20分）

20分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様
SSRで利用するSupabaseクライアントと、API URLユーティリティ、メモ用の型を用意します。

- 作成するファイル: `src/utils/supabase/server.ts`、`src/lib/api.ts`、`src/types/memo.ts`
- クライアント生成:
  - ライブラリは`@supabase/ssr`を使い、`createServerClient`で生成する
  - 関数名は`createClient`（async）とし、`next/headers`の`cookies()`から取得したCookieを`getAll`/`setAll`で渡す
  - 環境変数は`NEXT_PUBLIC_SUPABASE_URL`と`NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`を使用する
  - 参考: [公式ドキュメント](https://supabase.com/docs/guides/getting-started/tutorials/with-nextjs?queryGroups=language&language=ts#server-side-rendering-ssr)
- APIユーティリティ:
  - `apiUrl(path)`を実装し、`NEXT_PUBLIC_BASE_URL`を先頭に付与する
  - 末尾のスラッシュが重ならないように調整する
- 型定義:
  - `Memo`、`MemoCreateInput`、`MemoUpdateInput`を定義する
- 注意:
  - 余計なラッパー関数やクラスは追加しない
  - ベースURLを直書きしない

【使用タグ】
- （該当なし）

### ヒント

- SSR向けのクライアントは `@supabase/ssr` の `createServerClient` を使用します。
- `next/headers` の `cookies()` から取得したCookieを `getAll`/`setAll` で渡します。
- 環境変数は `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` を参照します。
- `apiUrl(path)` は先頭スラッシュを保証し、`NEXT_PUBLIC_BASE_URL` の末尾スラッシュを削除してから結合します。
- ベースURLを直書きせず、環境変数経由に統一します。

### 解答例

```ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  );
}

```

```ts
// APIエンドポイントのフルURLを生成するユーティリティ
// NEXT_PUBLIC_BASE_URL を先頭に付与し、二重スラッシュを避けます
const BASE = (process.env.NEXT_PUBLIC_BASE_URL || '').replace(/\/$/, '');

export function apiUrl(path: string) {
  const p = path.startsWith('/') ? path : `/${path}`;
  return `${BASE}${p}`;
}

```

```ts
export type Memo = {
  id: string;
  title: string;
  content: string;
  created_at: string; // ISO string
  updated_at: string; // ISO string
};

export type MemoCreateInput = {
  title: string;
  content: string;
};

export type MemoUpdateInput = Partial<MemoCreateInput>;

```

## 章末の確認

- SupabaseのSQLでpublicスキーマの`memos`テーブルが作成されている。
- `supabase/schema.sql` が作成され、定義が保存されている。
- `src/utils/supabase/server.ts`にクライアント生成関数（`createClient`）がある。
- `src/lib/api.ts`と`src/types/memo.ts`が作成されている。
