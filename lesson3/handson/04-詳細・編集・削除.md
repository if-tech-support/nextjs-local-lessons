## はじめに

詳細ページ（`/memos/[id]`）を実装し、1件のメモの表示・編集（PUT）・削除（DELETE）を行えるようにします。外部資料に依存せず、この章の手順だけで完成させます。

## 目的

- `/memos/[id]`で詳細を表示できる
- クライアントコンポーネントからのPUT/DELETEを実装できる
- 404時の分岐（`notFound()`）と`router.refresh()`/`router.push()`の使い分けを理解する

## 学習対象のスキル

- サーバーコンポーネントでの1件取得と404分岐
- クライアントコンポーネントからのPUT/DELETEとエラーハンドリング
- 画面内のナビゲーション（戻るボタン）

## 課題A：詳細ページを作る（8分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

1. ファイルパス（作成）
   - `src/app/memos/[id]/page.tsx`
2. 要素構造と順序（親→子）
   - ページ最上位に見出し、その下にメモ内容のカード、編集フォーム、操作ボタン行の順に配置する。
   - 404時は未レンダーとし、`notFound()`を返す。
3. 具体数値
   - 見出しは約24px。
   - カード内側余白は約16px。
   - 要素間の縦方向の間隔は約24px。
4. 最小禁止事項
   - 余計なラッパーを増やさない。
5. 使用タグセクション
   - 【使用タグ】
     - `<div>` 最上位コンテナー
       - `<h1>` ページ見出し
       - `<div>` 詳細カード
         - `<h2>` タイトル
         - `<p>` 本文
         - `<p>` 日時
       - `<form>` 編集フォーム（別課題で実装）
       - `<div>` 操作ボタン行

### ヒント

Tailwindの例：`space-y-6` `text-2xl` `font-bold` `p-4` `rounded`

### 解答例

```tsx
import BackButton from './BackButton';
import { Memo } from '@/types/memo';
import { apiUrl } from '@/lib/api';
import { notFound } from 'next/navigation';
import EditMemoForm from './EditMemoForm';
import DeleteMemoButton from './DeleteMemoButton';

async function fetchMemo(id: string): Promise<Memo | null> {
  const res = await fetch(apiUrl(`/api/memos/${id}`), {
    cache: 'no-store',
  });
  if (res.status === 404) return null;
  if (!res.ok) throw new Error('Failed to fetch memo');
  return res.json();
}

export default async function MemoDetail({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const memo = await fetchMemo(id);
  if (!memo) return notFound();
  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold text-sky-900">メモ詳細</h1>

      <div className="p-4 bg-white rounded">
        <h2 className="text-xl font-semibold text-sky-900">{memo.title}</h2>
        <p className="mt-2 whitespace-pre-wrap">{memo.content}</p>
        <p className="mt-3 text-sm text-sky-800">
          作成: {new Date(memo.created_at).toLocaleString()} / 更新: {new Date(memo.updated_at).toLocaleString()}
        </p>
      </div>

      <EditMemoForm id={memo.id} initialTitle={memo.title} initialContent={memo.content} />

      <div className="space-x-3">
        <DeleteMemoButton id={memo.id} />
        <BackButton />
      </div>
    </div>
  );
}

```

## 課題B：編集フォームを作る（10分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

1. ファイルパス（作成）
   - `src/app/memos/[id]/EditMemoForm.tsx`
2. 要素構造と順序（親→子）
   - 見出し、タイトル入力、詳細入力、メッセージ、送信ボタンの順。
   - 送信成功時は「更新しました」を表示し、一覧を再取得して反映する（`router.refresh()`）。
3. 具体数値
   - 入力の上下内側余白は約8px、左右は約12px。
   - テキストエリアの高さは約112px。
4. 最小禁止事項
   - 余計なラッパーを増やさない。
5. 使用タグセクション
   - 【使用タグ】
     - `<form>` フォーム
       - `<h3>` 見出し
       - `<div>` 入力グループ
         - `<label>` ラベル
         - `<input>` タイトル
       - `<div>` 入力グループ
         - `<label>` ラベル
         - `<textarea>` 本文
       - `<p>` メッセージ（任意）
       - `<div>` ボタン行

### ヒント

Tailwindの例：`p-4` `rounded` `border` `h-28` `gap-2`

### 解答例

```tsx
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';

type Props = {
  id: string;
  initialTitle: string;
  initialContent: string;
};

export default function EditMemoForm({ id, initialTitle, initialContent }: Props) {
  const router = useRouter();
  const [title, setTitle] = useState(initialTitle);
  const [content, setContent] = useState(initialContent);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    setSaved(false);
    try {
      const res = await fetch(`/api/memos/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content }),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data?.error ?? `Failed with ${res.status}`);
      }
      setSaved(true);
      router.refresh();
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : '更新に失敗しました';
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={onSubmit} className="space-y-4 p-4 border rounded bg-white">
      <h3 className="font-semibold">編集</h3>
      <div className="space-y-2">
        <label className="block text-sm">タイトル</label>
        <input
          name="title"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="w-full border rounded px-3 py-2"
        />
      </div>
      <div className="space-y-2">
        <label className="block text-sm">詳細</label>
        <textarea
          name="content"
          value={content}
          onChange={(e) => setContent(e.target.value)}
          className="w-full border rounded px-3 py-2 h-28"
        />
      </div>
      {error && <p className="text-sm text-red-600">{error}</p>}
      {saved && <p className="text-sm text-green-700">更新しました</p>}
      <div className="flex gap-2">
        <button
          type="submit"
          disabled={loading}
          className="inline-flex items-center text-white bg-green-600 hover:bg-green-700 disabled:opacity-50 px-4 py-2 rounded"
        >
          {loading ? '更新中...' : '更新'}
        </button>
      </div>
    </form>
  );
}

```

## 課題C：削除ボタンと戻るボタンを作る（12分）

5分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

1. ファイルパス（作成）
   - `src/app/memos/[id]/DeleteMemoButton.tsx`
   - `src/app/memos/[id]/BackButton.tsx`
2. 要素構造と順序（親→子）
   - 削除ボタンはクリック時に確認ダイアログ、成功時に`/memos`へ遷移し、直後に`router.refresh()`を呼ぶ。
   - 戻るボタンは`router.back()`で1つ前に戻る。
3. 具体数値
   - ボタンの左右余白は約16px、上下は約8px。
4. 最小禁止事項
   - 余計なラッパーを増やさない。
5. 使用タグセクション
   - 【使用タグ】
     - `<div>` ラッパー
       - `<button>` 削除
       - `<button>` 戻る

### ヒント

Tailwindの例：`inline-flex` `px-4` `py-2` `rounded` `hover:cursor-pointer`

### 解答例

```tsx
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';

export default function DeleteMemoButton({ id }: { id: string }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const onClick = async () => {
    if (!confirm('本当に削除しますか？')) return;
    setLoading(true);
    setError(null);
    try {
      const res = await fetch(`/api/memos/${id}`, { method: 'DELETE' });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data?.error ?? `Failed with ${res.status}`);
      }
      router.push('/memos');
      router.refresh();
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : '削除に失敗しました';
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="inline-block mr-3">
      {error && <p className="text-sm text-red-600 mb-2">{error}</p>}
      <button
        onClick={onClick}
        disabled={loading}
        className="inline-flex items-center bg-red-600 disabled:opacity-50 px-4 py-2 rounded text-white hover:cursor-pointer"
      >
        {loading ? '削除中...' : '削除'}
      </button>
    </div>
  );
}

```

```tsx
'use client';
import { useRouter } from 'next/navigation';

export default function BackButton() {
  const router = useRouter();
  return (
    <button onClick={() => router.back()} className="text-blue-600 hover:underline hover:cursor-pointer">
      戻る
    </button>
  );
}

```

## 章末の確認

- 開発サーバーを起動し、一覧から任意のメモの「詳細」へ遷移する。

```bash
npm run dev
```

- `/memos/[id]`で次を確認する。
  - 見出し「メモ詳細」と本文カード（タイトル/本文/作成・更新日時）が表示される。
  - フォームで編集して送信すると「更新しました」が表示され、内容が更新される。
  - 「削除」を押すと確認ダイアログの後に一覧へ遷移し、一覧が更新される。
  - 「戻る」で直前のページに戻れる。

以上で、詳細表示・編集・削除の最小機能が完成です。
