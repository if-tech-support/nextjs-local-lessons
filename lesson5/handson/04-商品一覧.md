## はじめに

商品一覧を取得し表示する基礎とカート内件数表示を段階追加する。

## 目的

商品一覧を表示してからカート内数量合計を同一ページで表示する。

## 学習対象のスキル

- Supabase SDK

## 課題A：商品一覧表示（6分）

6分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

商品テーブルを取得し商品一覧を表示する。

- 対象ファイル:`src/app/products/page.tsx`（新規作成）
- データ取得関数: `getProducts`
  - データ取得: 商品テーブルから`id` `name` `description` `price`を`created_at`の昇順で取得して、`data`には`products`、`error`には`productsError`と別名を付ける
  - 戻り値: `products`を返す
  - データ取得エラー:  エラー（`productsError`）を投げる
  - 例外時: エラーを投げる（try-catch後に再度throw）
- ページ関数: `ProductsPage`
  - `getProducts`を呼び出して結果を変数`products`に格納する
  - 見出し: ピンク系文字色#db2777で「商品一覧」
  - 商品カード（名前/説明/価格）: 商品名はピンク系文字色#db2777、説明は薄いグレー#6b7280、価格表示は先頭に`¥`を付け数値をそのまま表示、枠線/内側余白12px/角丸/要素間縦4px
  - 一覧表示: `ul`直下`li`を商品件数分。並び順は取得順で、取得した`products`を`map`メソッドを使って表示
  - 状態: Hooksは未使用（サーバーコンポーネントのみ）

【使用タグ】
- `div`（最上位コンテナー）
  - `h1`（見出し）
  - `ul`（一覧）
    - `li`（商品カード）
      - `p`（商品名）
      - `p`（説明）
      - `p`（価格）
    - `p`（0件時「該当なし」表示）

【命名】
- 関数: `getProducts` `ProductsPage`
- 定数/変数: `products` `supabase`
- その他: 追加命名なし（既存のみ使用）

【参照】
- 識別子: `createClient` `dynamic`

### ヒント

- Supabaseクライアント: `createClient()`
- 取得順: `.order('created_at')`

Tailwindの例：`text-lg` `font-bold` `border` `p-3` `rounded`

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getProducts() {
  try {
    const supabase = await createClient();
    const { data: products, error: productsError } = await supabase
      .from('products')
      .select('id, name, description, price')
      .order('created_at');
    if (productsError) throw productsError;
    return products;
  } catch (e) {
    throw e;
  }
}

export default async function ProductsPage() {
  const products = await getProducts();
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">商品一覧</h1>
      <ul className="space-y-3">
        {products.map((product) => (
          <li key={product.id} className="border p-3 rounded space-y-1">
            <p className="font-semibold text-pink-600">{product.name}</p>
            <p className="text-xs text-gray-600">{product.description}</p>
            <p className="text-sm">¥{product.price}</p>
          </li>
        ))}
        {!products.length && <p className="text-sm text-gray-500">該当なし</p>}
      </ul>
    </div>
  );
}
```

## 課題B：カート件数表示追加（6分）

6分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

カートテーブルを追加取得しカート内合計数量を一覧上部に表示する。

- 対象ファイル:`src/app/products/page.tsx`（課題Aの続き編集）
- データ取得関数: `getProductsAndCartItems`
  - データ取得: 商品テーブルからの取得に加え、カートテーブルから`temp_user_id`=`demo-user`で`quantity`を取得して、`data`には`cartItems`、`error`には`cartItemsError`と別名を付ける
  - 戻り値: オブジェクトの形で`products`と`cartItems`を返す
  - データ取得エラー:  エラー（`cartItemsError`）を投げる
- ページ関数: `ProductsPage`
  - 表示内容: 見出し下に`p`で「カート内: {合計} 点」、文字サイズ`text-xs`で文字色`text-gray-500`
  - 合計算出: `cart_items.quantity`を加算
  - レイアウト: `h1`直後に件数`p`追加

【使用タグ】
- `div`（最上位コンテナー）
  - `h1`（見出し）
  - `p`（件数表示）
  - `ul`（一覧）
    - `li`（商品カード）
      - `p`（商品名）
      - `p`（説明）
      - `p`（価格）
    - `p`（0件時「該当なし」表示）

【命名】
- 関数: `getProductsAndCartItems` `ProductsPage`
- 定数/変数: `products` `cartItems` `cartCount` `supabase`
- その他: 追加命名なし（既存のみ使用）

【参照】
- 識別子: `createClient` `dynamic`

### ヒント

- 合計: `reduce`で数量加算
- 既存一覧コードを保持し件数行を追加

Tailwindの例：`text-xs` `text-gray-500` `space-y-3` `border` `rounded`

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getProductsAndCartItems() {
  try {
    const supabase = await createClient();
    const { data: products, error: productsError } = await supabase
      .from('products')
      .select('id, name, description, price')
      .order('created_at');
    const { data: cartItems, error: cartItemsError } = await supabase
      .from('cart_items')
      .select('quantity')
      .eq('temp_user_id', 'demo-user');
    if (productsError) throw productsError;
    if (cartItemsError) throw cartItemsError;
    return { products, cartItems };
  } catch (e) {
    throw e;
  }
}

export default async function ProductsPage() {
  const { products, cartItems } = await getProductsAndCartItems();
  const cartCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">商品一覧</h1>
      {/* 以下新規追加 */}
      <p className="text-xs text-gray-500">カート内: {cartCount} 点</p>
      <ul className="space-y-3">
        {products.map((product) => (
          <li key={product.id} className="border p-3 rounded space-y-1">
            <p className="font-semibold text-pink-600">{product.name}</p>
            <p className="text-xs text-gray-600">{product.description}</p>
            <p className="text-sm">¥{product.price}</p>
          </li>
        ))}
        {!products.length && <p className="text-sm text-gray-500">該当なし</p>}
      </ul>
    </div>
  );
}
```

## 章末の確認

- 商品一覧が取得順で表示される
- カート内件数が合計数量で表示される
- 0件時に「該当なし」が表示される
- エラーなく再読み込みできる

```bash
npm run dev
```
