## はじめに

商品一覧にカート追加機能を加える。

## 目的

商品一覧に数量加算ボタンを置きServer Actionで`cart_items`へ追加または数量更新し一覧を再取得する状態を作る。

## 学習対象のスキル

- Server Action基本
- Form送信とDB更新
- Supabase行の取得と条件分岐
- ページ再検証（再読み込み誘発）

## 課題A：addToCartActionを作る（8分）

8分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

カートへ商品を1点追加し既存なら数量+1するServer Actionを作る。

- 対象ファイル:`src/lib/actions.ts`（新規作成）
- 宣言位置: 先頭に`'use server'`
- 関数: `addToCartAction(FormData)`をexport
- 入力: `FormData`から`id`を文字列取得
- 不正入力: `id`が文字列でない時は何もせずreturn
- 既存判定: `cart_items`を`temp_user_id`=`demo-user`かつ`product_id`=`id`で1件取得
- 既存あり: `quantity`を+1で`update`
- 既存なし: 行を`{ temp_user_id:'demo-user', product_id:id, quantity:1 }`で`insert`
- エラー: 取得/更新/挿入の`error`があればthrow
- 後処理: `/products` `/orders` `/cart`を`revalidatePath`で再検証
- 戻り値: なし（呼び出し側はUI再描画）
- 例外時: `console.error(e)`し再検証は実行
- ユーザー識別: 関数`tempUserId()`で`'demo-user'`返却
- 制約: 他の注文/更新系Actionはまだ定義しない

【使用タグ】
- なし（サーバーコードのため）

【命名】
- 関数: `addToCartAction` `tempUserId`
- 定数/変数: `id` `supabase` `existing`
- その他: 追加命名なし（既存のみ使用）

【参照】
- 識別子: `revalidatePath` `createClient`

### ヒント

- 1件取得: `.maybeSingle()`
- 条件: `.eq('product_id', id)`
- 数量加算: `existing.quantity + 1`
- 再検証: `revalidatePath('/products')`など3回

### 解答例

```ts
'use server';
import { revalidatePath } from 'next/cache';
import { createClient } from '@/lib/supabase/server';

function tempUserId() {
  return 'demo-user';
}

export async function addToCartAction(formData: FormData) {
  try {
    const id = formData.get('id');
    if (typeof id !== 'string') return;
    const supabase = await createClient();
    const { data: existing, error } = await supabase
      .from('cart_items')
      .select('id, quantity')
      .eq('temp_user_id', tempUserId())
      .eq('product_id', id)
      .maybeSingle();
    if (error) throw error;
    if (existing) {
      const { error } = await supabase
        .from('cart_items')
        .update({ quantity: existing.quantity + 1 })
        .eq('id', existing.id);
      if (error) throw error;
    } else {
      const { error } = await supabase
        .from('cart_items')
        .insert({ temp_user_id: tempUserId(), product_id: id, quantity: 1 });
      if (error) throw error;
    }
  } catch (e) {
    console.error(e);
  } finally {
    revalidatePath('/products');
    revalidatePath('/orders');
    revalidatePath('/cart');
  }
}
```

## 課題B：商品一覧に追加ボタン（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

商品一覧各カードにカート追加フォームを付与し数量を加算する。

- 対象ファイル:`src/app/products/page.tsx`（既存編集）
- 既存構造: 最上位`div`→`h1`→件数`p`→`ul`
- 変更内容: 各`li`末尾に`form`追加
- フォーム構造: `form`内に`input type="hidden" name="id" value=商品id`と`button`1個
- 送信方式: Server Actionの`action={addToCartAction}`属性
- ボタン文言:「カートに追加」
- ボタン装飾: 背景#ec4899文字白/内側余白8px/角丸/文字サイズ極小
- 関数参照: `addToCartAction`をインポート
- 件数表示: 既存`cartCount`行保持（加算後再取得で反映）
- エラー処理: 既存の例外処理構造保持
- 先行要素: 今章では遅延読み込み説明なし
- 禁止: 余計なラッパー`div`追加

【使用タグ】
- `div`（最上位コンテナー）
  - `h1`（見出し）
  - `p`（件数表示）
  - `ul`（一覧）
    - `li`（商品カード）
      - `p`（商品名）
      - `p`（説明）
      - `p`（価格）
      - `form`（追加フォーム）
        - `input`（hidden id）
        - `button`（追加）
    - `p`（0件時「該当なし」）

【命名】
- 関数: `getProductsAndCartItems` `ProductsPage` `addToCartAction`
- 定数/変数: `products` `cartItems` `cartCount` `supabase`
- その他: 追加命名なし（既存のみ使用）

【参照】
- 識別子: `createClient` `dynamic`

### ヒント

- 隠し入力: `<input type="hidden" name="id" value={product.id} />`
- 数量再表示: 再検証後の再描画に依存
- 追加: updateとinsertはAction側で分岐済

Tailwindの例：
`bg-pink-500` `text-white` `p-2` `rounded` `text-xs`

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';
import { addToCartAction } from '@/lib/actions';

export const dynamic = 'force-dynamic';

async function getProductsAndCartItems() {
  try {
    const supabase = await createClient();
    const { data: products, error: productsError } = await supabase
      .from('products')
      .select('id, name, description, price')
      .order('created_at');
    const { data: cartItems, error: cartItemsError } = await supabase
      .from('cart_items')
      .select('quantity')
      .eq('temp_user_id', 'demo-user');
    if (productsError) throw productsError;
    if (cartItemsError) throw cartItemsError;
    return { products, cartItems };
  } catch (e) {
    throw e;
  }
}

export default async function ProductsPage() {
  const { products, cartItems } = await getProductsAndCartItems();
  const cartCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">商品一覧</h1>
      <p className="text-xs text-gray-500">カート内: {cartCount} 点</p>
      <ul className="space-y-3">
        {products.map((product) => (
          <li key={product.id} className="border p-3 rounded space-y-1">
            <p className="font-semibold text-pink-600">{product.name}</p>
            <p className="text-xs text-gray-600">{product.description}</p>
            <p className="text-sm">¥{product.price}</p>
            <form action={addToCartAction} className="mt-1">
              <input type="hidden" name="id" value={product.id} />
              <button className="bg-pink-500 text-white p-2 rounded text-xs">カートに追加</button>
            </form>
          </li>
        ))}
        {!products.length && <p className="text-sm text-gray-500">該当なし</p>}
      </ul>
    </div>
  );
}
```

## 章末の確認

- 追加ボタン押下で数量が+1になる
- 同一商品を複数押下で数量加算
- 件数表示が再描画で更新
- エラーなく再読み込み可能

```bash
npm run dev
```
