## はじめに

カート内容から注文を確定し注文履歴（合計と明細）を1ページで完結表示する流れを、3段階（取得関数→ページ骨組み→履歴表示）で段階学習します。

## 目的

データ取得関数を分離し、合計計算とServer Action連携を含むページ骨組みを先に整え、最後に履歴表示コンポーネントを実装して全体を統合する。

## 課題A：取得関数の作成（7分）

7分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

まずはページや表示を作らず「取得関数」だけを `page.tsx` 内部に実装します。戻り値の構造を把握することが後続ステップのミス削減につながります。

### 仕様
カートと注文の取得関数を定義し、件数をログで確認する。
- 対象ファイル: `src/app/orders/page.tsx`（新規作成、まだデフォルトエクスポートは仮でOK）
- `export const dynamic = 'force-dynamic'` を先頭付近に宣言
- `getCartItems()` を実装し `cart_items` から `quantity, products(price)` を `temp_user_id='demo-user'` で取得
- `getOrders()` を実装し `orders` から `id, created_at, order_items(id, quantity, price_at_order, products(name))` を `temp_user_id='demo-user'` で取得し `created_at` 降順
- それぞれエラーハンドリング（`if (error) throw error;`）
- 暫定のページ関数 `OrdersPage` は両関数を呼び `console.log` で件数を出力するのみ

【命名】
- 関数: `getCartItems` `getOrders` `OrdersPage`

【参照】
- インポート識別子: `createClient`

【使用タグ】
- なし（サーバーコードのため）

### ヒント
- Supabaseサーバークライアント: `createClient()`
- ソート: `.order('created_at', { ascending: false })`
- 動作確認はコンソール出力（ブラウザorターミナル）で件数を見る

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

export default async function OrdersPage() {
  const cart = await getCartItems();
  const orders = await getOrders();
  console.log('cart items:', cart?.length, 'orders:', orders?.length); // 確認用
  return <div>Loading...</div>; // 次課題で置き換え
}
```

---

## 課題B：OrdersPage 骨組み（8分）

8分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

課題Aの関数を利用してページ本体を整えます。履歴リスト本体（`OrderHistory`）はまだ実装せずプレースホルダーを表示します。

### 仕様
合計を表示し、合計が正のとき注文確定フォームを表示するページ骨組みを作る。
- `OrdersPage` 内で `getCartItems()` を呼び合計金額 `total` を算出（価格×数量）
- 見出し「注文」
- 合計表示: `カート合計: ¥<total>`（0の場合も表示）
- `total > 0` のときのみ `注文確定` ボタン付き `<form action={placeOrderAction}>` を表示
- `OrderHistory` はこの段階では仮: `<div className="text-sm text-gray-500">履歴読込予定...</div>`
- スタイル: 縦方向の間隔は約16px、見出しはやや大きめで太字、合計は小さめの文字、ボタンはピンク系背景に白文字で左右約16px・上下約4pxの余白、角は小さく丸める（1要素あたりユーティリティは5個以内）

【命名】
- 関数/コンポーネント: `OrdersPage` `OrderHistory`
- Action: `placeOrderAction`

【参照】
- インポート識別子: `placeOrderAction`（`@/lib/actions`）

【使用タグ】
- `div`
  - `h1`
  - `p`
  - `form`
    - `button`
  - `OrderHistory`

### ヒント
- 合計: `reduce` で `(item.products?.price || 0) * item.quantity`
- Actionは後工程と同じ `placeOrderAction` を直接指定可

Tailwindの例：`space-y-4` `text-sm` `font-bold` `bg-pink-600` `rounded`

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';
import { placeOrderAction } from '@/lib/actions';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

async function OrderHistory() { // 仮実装
  return <div className="text-sm text-gray-500">履歴読込予定...</div>;
}

export default async function OrdersPage() {
  const cartItems = (await getCartItems()) ?? [];
  const total = cartItems.reduce((s, i) => s + (i.products?.price || 0) * i.quantity, 0);
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">注文</h1>
      <p className="text-sm">カート合計: ¥{total}</p>
      {total > 0 && (
        <form action={placeOrderAction}>
          <button className="bg-pink-600 text-white px-4 py-1 rounded">注文確定</button>
        </form>
      )}
      <OrderHistory />
    </div>
  );
}
```

---

## 課題C：OrderHistory 実装と最終統合（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

履歴一覧と明細を表示する `OrderHistory` を完成させ、1ページで「合計表示 → 注文確定 → 再描画 → 履歴反映」が成立する形にします。

### 仕様
注文履歴を新しい順で表示し、空時メッセージ・明細・注文計を含めた一覧を完成させる。
- これまでの要件 + 以下
- 履歴: 0件なら「まだ注文はありません」
- 各注文: ID（小さめの灰色文字）を表示
- 明細: 商品名・数量・行小計
- 注文計: 右寄せ「計 ¥<合計>」
- 合計、小計は単純整数（フォーマット簡易）

【命名】
- コンポーネント/関数: `OrderHistory` `OrdersPage`

【参照】
- インポート識別子: `createClient` `placeOrderAction`

【使用タグ】
- `ul`
  - `li`
    - `div`
      - `p`
    - `ul`
      - `li`
        - `span`
        - `span`
    - `p`

### 使用主フィールド再掲
`cart_items(quantity, products.price)`  /  `orders(id, created_at)`  /  `order_items(id, quantity, price_at_order, products(name))`

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';
import { placeOrderAction } from '@/lib/actions';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

async function OrderHistory() {
  const data = await getOrders();
  const orders = data || [];
  if (!orders.length) return <p className="text-sm text-gray-500">まだ注文はありません</p>;
  return (
    <ul className="space-y-4">
      {orders.map((order) => {
        const sum = order.order_items.reduce((s, item) => s + item.price_at_order * item.quantity, 0);
        return (
          <li key={order.id} className="border p-3 rounded space-y-2">
            <div className="flex justify-between items-center">
              <p className="text-xs text-gray-500">{order.id}</p>
            </div>
            <ul className="space-y-1">
              {order.order_items.map((item) => (
                <li key={item.id} className="flex justify-between text-sm">
                  <span>{item.products?.name} x {item.quantity}</span>
                  <span>¥{item.price_at_order * item.quantity}</span>
                </li>
              ))}
            </ul>
            <p className="text-right text-sm font-semibold">計 ¥{sum}</p>
          </li>
        );
      })}
    </ul>
  );
}

export default async function OrdersPage() {
  const cartItems = (await getCartItems()) ?? [];
  const total = cartItems.reduce((sum, item) => sum + (item.products?.price || 0) * item.quantity, 0) || 0;
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">注文</h1>
      <p className="text-sm">カート合計: ¥{total}</p>
      {total > 0 && (
        <form action={placeOrderAction}>
          <button className="bg-pink-600 text-white px-4 py-1 rounded">注文確定</button>
        </form>
      )}
      <OrderHistory />
    </div>
  );
}
```

---

## 章末の確認

### 段階別
- A: 取得関数が正しく件数をログ出力できる
- B: 合計金額と注文確定フォーム（条件表示）が正しい / 履歴はプレースホルダー
- C: 履歴表示（新しい順 / 空表示 / 明細 / 注文計）が完成

### 最終挙動
- 注文確定ボタン押下で注文が追加されリストが再描画される
- 空状態で「まだ注文はありません」が表示される
- 各注文に商品名・数量・行小計・注文計が表示される

```bash
npm run dev
curl -i "http://localhost:3000/orders"
```
