## はじめに

カート内容から注文を確定し注文履歴（合計と明細）を1ページで完結表示する流れを、3段階（取得関数→ページ骨組み→履歴表示）で段階的に学習します。

## 目的

データ取得関数を分けて定義して、合計計算とServer Action連携を含むページ骨組みを先に実装し、最後に履歴表示コンポーネントを実装して全体を統合する。

## 課題A：取得関数の作成（7分）

7分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

カートと注文の取得関数を定義し、件数をログで確認する。

- 対象ファイル: `src/app/orders/page.tsx`（新規作成、まだデフォルトエクスポートは仮でOK）
- 先頭付近に宣言: `export const dynamic = 'force-dynamic'`
- 関数: `getCartItems()`
  - 動作: `cart_items` から `quantity, products(price)` を `temp_user_id='demo-user'` で取得
  - エラー: `if (error) throw error;`
- 関数: `getOrders()`
  - 動作: `orders` から `id, created_at, order_items(id, quantity, price_at_order, products(name))` を `temp_user_id='demo-user'` で取得し `created_at` 降順
  - エラー: `if (error) throw error;`
- 動作確認用の記述: ページ関数 `OrdersPage` は両関数を呼び `console.log` で件数を出力するのみ

【命名】
- 関数: `getCartItems` `getOrders` `OrdersPage`

【参照】
- インポート識別子: `createClient`

【使用タグ】
- なし（サーバーコードのため）

### ヒント
- Supabaseサーバークライアント: `createClient()`
- ソート: `.order('created_at', { ascending: false })`
- 動作確認はコンソール出力（ブラウザorターミナル）で件数を見る

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

export default async function OrdersPage() {
  const cart = await getCartItems();
  const orders = await getOrders();
  console.log('cart items:', cart?.length, 'orders:', orders?.length); // 確認用
  return <div>Loading...</div>; // 次課題で置き換え
}
```

---

## 課題B：注文一覧画面の骨組み（8分）

8分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

合計を表示し、合計が正のとき注文確定フォームを表示するページの骨組みを作る。

- 履歴リスト用コンポーネント: `OrderHistory`
  - この段階では仮実装: `<div className="text-sm text-gray-500">履歴読込予定...</div>`のみにする
- ページ関数: `OrdersPage`
  -  `getCartItems()` を呼び合計金額 `total` を算出（価格×数量）
  - 見出し: `h1`で「注文」を表示
  - 合計表示: `カート合計: ¥<total>`（0の場合も表示）
  - `total > 0` のときのみ `注文確定` ボタン付き `<form action={placeOrderAction}>` を表示
  - スタイル: 縦方向の間隔は約16px、見出しはやや大きめで太字、合計は小さめの文字、ボタンはピンク系背景に白文字で左右約16px・上下約4pxの余白、角は小さく丸める（1要素あたりユーティリティは5個以内）

【命名】
- 関数/コンポーネント: `OrdersPage` `OrderHistory`
- Action: `placeOrderAction`

【参照】
- インポート識別子: `placeOrderAction`（`@/lib/actions`）

【使用タグ】
- `div`
  - `h1`
  - `p`
  - `form`
    - `button`
  - `OrderHistory`

### ヒント
- 合計: `reduce` で `(item.products?.price || 0) * item.quantity`
- Actionは後工程と同じ `placeOrderAction` を直接指定可

Tailwindの例：`space-y-4` `text-sm` `font-bold` `bg-pink-600` `rounded`

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';
import { placeOrderAction } from '@/lib/actions';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

async function OrderHistory() { // 仮実装
  return <div className="text-sm text-gray-500">履歴読込予定...</div>;
}

export default async function OrdersPage() {
  const cartItems = (await getCartItems()) ?? [];
  const total = cartItems.reduce((s, i) => s + (i.products?.price || 0) * i.quantity, 0);
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">注文</h1>
      <p className="text-sm">カート合計: ¥{total}</p>
      {total > 0 && (
        <form action={placeOrderAction}>
          <button className="bg-pink-600 text-white px-4 py-1 rounded">注文確定</button>
        </form>
      )}
      <OrderHistory />
    </div>
  );
}
```

---

## 課題C：注文履歴表示と仕上げ（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

注文履歴を新しい順で表示し、0件のメッセージ・明細・対象注文合計を含めた一覧を完成させる。

- 履歴リスト用コンポーネント: `OrderHistory` 
  - データ取得: `getOrders`を実行して戻り値を`data`に格納して、`data`を`orders`に格納するがdataがなければ`[ ]`を格納する
  - 履歴: 0件なら「まだ注文はありません」（文字サイズは`text-sm`）
  - `orders`を`map`メソッドを使ってリストで表示する
    - `map`メソッドの呼び出し直後に`reduce`を使い対象注文の合計金額を計算して`sum`に格納
    -  リストの項目は縦方向の間隔を1remにする
      - 項目自体は枠線つき・内側余白12px・角丸4px、その子要素同士を縦に8px間隔で並べる
    - 注文ID: `div`のラッパーの中に`p`で表示（文字サイズは`text-xs`で文字色は灰色）
      - ラッパー: 横並びのフレックスで、左右の端に振り分け、縦方向は中央揃え
    - 明細: 注文内容をリスト表示する
      - リストの項目は間隔を4px（0.25rem）にする
      - 項目自体は子要素を横並び（フレックス）で、左右端に均等配置し、文字サイズは`text-sm`にする
      - 商品名と数量は`span`で表示する
    - 対象注文合計: `p`で「計 ¥<合計>」を表示（文字を右寄せ、文字サイズは`text-sm`、文字の太さは`font-semibold`）

【命名】
- コンポーネント/関数: `OrderHistory` `OrdersPage`
- 注文履歴情報: `orders`
- 対象注文合計: `sum`

【参照】
- インポート識別子: `createClient` `placeOrderAction`

【使用タグ】
- `ul`
  - `li`
    - `div`
      - `p`
    - `ul`
      - `li`
        - `span`
        - `span`
    - `p`

### 解答例
```tsx
import { createClient } from '@/lib/supabase/server';
import { placeOrderAction } from '@/lib/actions';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('cart_items')
    .select('quantity, products(price)')
    .eq('temp_user_id', 'demo-user');
  if (error) throw error;
  return data;
}

async function getOrders() {
  const supabase = await createClient();
  const { data, error } = await supabase
    .from('orders')
    .select('id, created_at, order_items(id, quantity, price_at_order, products(name))')
    .eq('temp_user_id', 'demo-user')
    .order('created_at', { ascending: false });
  if (error) throw error;
  return data;
}

async function OrderHistory() {
  const data = await getOrders();
  const orders = data || [];
  if (!orders.length) return <p className="text-sm text-gray-500">まだ注文はありません</p>;
  return (
    <ul className="space-y-4">
      {orders.map((order) => {
        const sum = order.order_items.reduce((s, item) => s + item.price_at_order * item.quantity, 0);
        return (
          <li key={order.id} className="border p-3 rounded space-y-2">
            <div className="flex justify-between items-center">
              <p className="text-xs text-gray-500">{order.id}</p>
            </div>
            <ul className="space-y-1">
              {order.order_items.map((item) => (
                <li key={item.id} className="flex justify-between text-sm">
                  <span>{item.products?.name} x {item.quantity}</span>
                  <span>¥{item.price_at_order * item.quantity}</span>
                </li>
              ))}
            </ul>
            <p className="text-right text-sm font-semibold">計 ¥{sum}</p>
          </li>
        );
      })}
    </ul>
  );
}

export default async function OrdersPage() {
  const cartItems = (await getCartItems()) ?? [];
  const total = cartItems.reduce((sum, item) => sum + (item.products?.price || 0) * item.quantity, 0) || 0;
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">注文</h1>
      <p className="text-sm">カート合計: ¥{total}</p>
      {total > 0 && (
        <form action={placeOrderAction}>
          <button className="bg-pink-600 text-white px-4 py-1 rounded">注文確定</button>
        </form>
      )}
      <OrderHistory />
    </div>
  );
}
```

---

## 章末の確認

- 注文確定ボタン押下で注文が追加されリストが再描画される
- 空状態で「まだ注文はありません」が表示される
- 各注文に商品名・数量・行小計・注文計が表示される

```bash
npm run dev
```
