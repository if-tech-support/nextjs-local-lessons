## はじめに

アプリのDBスキーマ構造とSupabaseクライアント準備を行い商品/カート/注文データを扱える基盤を整える。

## 目的

商品/カート/注文/注文明細テーブル構造を理解し型定義とサーバー/ブラウザクライアントを初期化して後続の取得と更新に備える。

## 課題A：スキーマ作成と型生成（8分）

8分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

Supabase CLIで4テーブルをマイグレーションとして作成し適用し、初期データをシードで投入し、生成されたDBから型定義`supabase/types/database.ts`を作成して存在を確認する。

- 前提:`npx supabase start`でローカルSupabase起動済み
- マイグレーション作成:`npx supabase migration new init` を実行し生成SQLファイルに下記スキーマを貼り付け
- スキーマ内容: `products` `cart_items` `orders` `order_items` の4テーブル（主キーUUID/価格整数/注文時価格保持）
- シード: `supabase/seed.sql` を先に作成し初期商品6件を挿入（下記SQL貼付け）
- 適用:`npx supabase db reset` でマイグレーションとシードを一括適用（既存データ初期化）
- 型生成:`npx supabase gen types typescript --local --schema public > supabase/types/database.ts` 実行

コマンド手順（順に実行）:
```bash
npx supabase migration new init
# supabase/migrations/<timestamp>_init.sql 自動生成
# ファイルを開き下記SQLを貼り付け保存
# supabase/seed.sql 手動生成
# ファイルを開き下記SQLを貼り付け保存
npx supabase db reset # マイグレーションとシード適用
npx supabase gen types typescript --local --schema public > supabase/types/database.ts
```

マイグレーションSQL（`supabase/migrations/<timestamp>_init.sql`貼り付け）:
```sql
-- products
create table products (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  description text not null,
  price integer not null,
  created_at timestamptz default now()
);

-- cart_items (temp_user_id + product_id ユニーク)
create table cart_items (
  id uuid primary key default gen_random_uuid(),
  temp_user_id text not null,
  product_id uuid references products(id) on delete cascade,
  quantity integer not null default 1,
  created_at timestamptz default now(),
  unique (temp_user_id, product_id)
);

-- orders
create table orders (
  id uuid primary key default gen_random_uuid(),
  temp_user_id text not null,
  created_at timestamptz default now()
);

-- order_items
create table order_items (
  id uuid primary key default gen_random_uuid(),
  order_id uuid references orders(id) on delete cascade,
  product_id uuid references products(id) on delete restrict,
  quantity integer not null,
  price_at_order integer not null,
  created_at timestamptz default now()
);
```

シードSQL（`supabase/seed.sql`貼付け）:
```sql
insert into products (id,name,description,price) values
  (gen_random_uuid(),'Notebook','軽量ノートPC',120000),
  (gen_random_uuid(),'Headphones','ノイズキャンセルヘッドホン',30000),
  (gen_random_uuid(),'Keyboard','メカニカルキーボード',15000),
  (gen_random_uuid(),'Mouse','ワイヤレスマウス',8000),
  (gen_random_uuid(),'Monitor','27インチモニタ',40000),
  (gen_random_uuid(),'USB Hub','多ポートUSBハブ',6000);
```

## 課題B：Supabaseサーバークライアント準備（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

サーバーコンポーネント/Server Actions用のSupabaseクライアント生成関数を実装する。

- 対象ファイル:`src/lib/supabase/server.ts`（既存編集）
- 関数名: `createClient`（既存維持）
- 使用ライブラリ: `@supabase/ssr` の `createServerClient`
- 環境変数: `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` を利用
- セッション維持: `cookies()` を利用し `getAll` / `setAll` 実装
- 戻り値: 型パラメーターに `Database` を適用したSupabaseクライアント
- エラー処理: 例外は上位へ投げる（内部でcatchしない）
- コメント: 既存の英語コメント行はそのまま保持（追加必須なし）
- 既存コード: インラインコメントは保持可
- 外部差分: 既存の不要コメントは残してもよい

【使用タグ】
- `import`
  - `function`

### ヒント

- 既存コードが目的をほぼ満たすためコメント追記中心
- `cookies()` は非同期

### 解答例

```ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { Database } from '../../../supabase/types/database';

export async function createClient() {
  const cookieStore = await cookies();
  // Create a server's supabase client with newly configured cookie,
  // which could be used to maintain user's session
  return createServerClient<Database>(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!, {
    cookies: {
      getAll() {
        return cookieStore.getAll();
      },
      setAll(cookiesToSet) {
        try {
          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options));
        } catch {
          // The `setAll` method was called from a Server Component.
          // This can be ignored if you have middleware refreshing
          // user sessions.
        }
      },
    },
  });
}
```

## 課題C：ブラウザクライアントと環境変数（10分）

10分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

クライアントコンポーネント用のブラウザSupabaseクライアントを実装する。

- 対象ファイル:`src/lib/supabase/client.ts`（既存編集）
- 関数名: `createClient`（既存維持）
- 使用ライブラリ: `@supabase/ssr` の `createBrowserClient`
- 環境変数: サーバー側と同じ2つを利用
- 戻り値: 型パラメーターに `Database`
- コメント: 既存の英語コメント行はそのまま保持（追加必須なし）
- 余計なローカル状態やキャッシュロジックは追加しない
- 1要素あたりクラス指定は発生しないため制約対象外

【使用タグ】
- `import`
  - `function`

### ヒント

- コード数行で完結
- SSRでは使用せずクライアント限定

### 解答例

```ts
import { createBrowserClient } from '@supabase/ssr';
import { Database } from '../../../supabase/types/database';

export function createClient() {
  // Create a supabase client on the browser with project's credentials
  return createBrowserClient<Database>(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!);
}
```

## 章末の確認

- サーバー用`createClient`が型付与されcookies連携を行うか
- ブラウザ用`createClient`が型付与され環境変数参照するか
- 環境変数2種が`.env.local`に存在するか
- 型定義ファイル`supabase/types/database.ts`が存在するか

期待される結果（要点）
- `npm run dev` 実行で開発サーバーが起動し http://localhost:3000 にアクセスできる
- `server.ts` / `client.ts` の `createClient` 呼び出しで型補完（`products` などテーブル名）が効く
- サーバー側でcookies取得エラー/更新エラーが発生しない（ログ警告なし）
- ブラウザコンソールにSupabase関連のエラーが出ない
- `src/lib/db-schema-notes.ts` のER図コメントが後続課題で参照できる位置に存在

```bash
npm run dev
```
