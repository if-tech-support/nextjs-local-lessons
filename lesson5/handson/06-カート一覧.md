## はじめに

カート内の商品名・価格・数量・合計金額を一覧表示する基礎を作る。

## 目的

カートテーブルから対象ユーザーのレコードを取得し、商品名・価格・数量を一覧表示し合計金額を計算できる状態にする。

## 課題A：カート一覧取得関数を作る（7分）

7分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

カート一覧情報を取得する開数を定義してカート一覧画面表示の準備を行う。

- 対象ファイル: `src/app/cart/page.tsx`
- 関数: `getCartItems()` を同ファイル内に定義（エクスポートしない）
  - 取得テーブル: `cart_items`
  - 利用カラム: `id`（行ID）`quantity`（数量）リレーション`products(id, name, price)`（商品ID/商品名/価格）
  - 抽出条件: `temp_user_id` が文字列 `demo-user` と等しい行のみ
  - 並び順: `created_at` を昇順（古い順）
  - 戻り値: `data`
  - エラー: 取得失敗時はエラーを投げる
  - 例外時: `console.error(e)`
- ページ関数: `CartPage`
  - データ取得: `getCartItems`を呼び出して変数`data`に格納、取得結果がnullの場合は呼び出し側で空配列に置き換える（`const items = data || []`）
  - 最上位コンテナー: 子要素を縦に並べて1remの間隔にする
  - 見出し:「カート」を表示、文字サイズは`text-lg`、文字の太さは`font-bold`、文字色は`text-pink-600`
  - 件数表示: 件数は取得結果の要素数

【使用タグ】
- `div`（最上位コンテナー）
  - `h1`（見出し: カート）
  - `p`（件数表示: "項目数: <数>"）

【命名】
- 関数: `getCartItems`（取得関数）`CartPage`（ページ関数）
- 変数: `data`（クエリの取得結果）`items`（取得結果のnull判定後の配列）
- その他: 追加命名なし

【参照】
- 識別子: `createClient`（Supabaseクライアント生成）`dynamic`（動的キャッシュ指定`'force-dynamic'`）

### ヒント

- リレーション選択: `.select('id, quantity, products(id, name, price)')`
- 空配列対策: `const items = data || []`
- 件数表示: `items.length`

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  try {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('cart_items')
      .select('id, quantity, products(id, name, price)')
      .eq('temp_user_id', 'demo-user')
      .order('created_at');
    if (error) throw error;
    return data;
  } catch (e) {
    throw e;
  }
}

export default async function CartPage() {
  const data = await getCartItems();
  const items = data || [];
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">カート</h1>
      <p className="text-sm">項目数: {items.length}</p>
    </div>
  );
}
```

## 課題B：カート一覧UIを作る（9分）

9分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

取得データを用いて商品名・価格・数量と合計金額を表示する一覧UIを実装する。

- 対象ファイル: `src/app/cart/page.tsx`（既存編集）
- 合計計算: 配列をループ処理して「価格（価格が未定義なら0）×数量」を加算した総和を算出し数値 `total` に格納
- 合計金額: 小さめ文字（`text-sm`）で、カートの合計金額 `total` を「¥」付きで表示
- 商品一覧: `items`の要素が0（空）なら、「カートは空です」という灰色・小さめ文字のメッセージを表示
- リスト全体: `ul`直下の各 <li> 同士の縦の間隔を0.75rem空ける（`space-y-3`）
- 項目自体: `li`は薄い枠線（`border`）、内側余白0.75rem（`p-3`）、角丸（`rounded`）、子要素の縦間隔を0.5rem（`space-y-2`）空ける
- 商品名: 小さめ・やや太字で表示、オプショナルチェーン（`?.`）で、productsが未定義でもエラーにせず`undefined`を返す
- 価格: 文字サイズは`text-xs`、 文字色は`text-gray-500`
- 購入数量: 文字サイズは`text-xs`、文字色は`text-gray-500`
- 通貨表記: 価格と合計はいずれも先頭に `¥` を付け整数表示

【使用タグ】
- `div`（最上位）
  - `h1`（タイトル: カート）
  - `p`（合計金額: "合計: ¥<金額>"）
  - `ul`（商品一覧）
    - `li`（商品行）
      - `p`（商品名）
      - `p`（価格）
      - `p`（数量: "数量: <数>"）
    - `p`（空時メッセージ: 件数0のときのみ）

【命名】
- 関数: `getCartItems` `CartPage`
- 変数: `data` `items` `total`
- その他: 追加命名なし

【参照】
- 識別子: `createClient` `dynamic`

### ヒント

- 合計: `価格(価格が未定義なら0) × 数量 を全行で加算`
- 数量表示: `item.quantity` をそのまま
- 空判定: 件数が0なら空メッセージ行のみ表示

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  try {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('cart_items')
      .select('id, quantity, products(id, name, price)')
      .eq('temp_user_id', 'demo-user')
      .order('created_at');
    if (error) throw error;
    return data;
  } catch (e) {
    throw e;
  }
}

export default async function CartPage() {
  const data = await getCartItems();
  const items = data || [];
  const total = items.reduce((sum, item) => sum + (item.products?.price || 0) * item.quantity, 0);
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">カート</h1>
      <p className="text-sm">合計: ¥{total}</p>
      {!items.length && <p className="text-sm text-gray-500">カートは空です</p>}
      <ul className="space-y-3">
        {items.map((item) => (
          <li key={item.id} className="border p-3 rounded space-y-2">
            <p className="text-sm font-semibold">{item.products?.name}</p>
            <p className="text-xs text-gray-500">¥{item.products?.price}</p>
            <p className="text-xs text-gray-500">数量: {item.quantity}</p>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

## 章末の確認

- 商品名 / 価格 / 数量が一覧表示される
- 合計金額が各（価格×数量）の総和になる
- 空時に「カートは空です」が1行表示される
- 件数0→1追加後に表示が変わる（再読み込み後も維持）
- 価格と合計は `¥` プレフィックス付き

```bash
npm run dev
```
