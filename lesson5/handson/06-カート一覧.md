## はじめに

カート内の商品名・価格・数量・合計金額を一覧表示する基礎を作る。

## 目的

カートテーブルから対象ユーザーの行を取得し商品名・価格・数量を一覧表示し合計金額を計算できる状態を整える。

## 学習対象のスキル

- サーバーコンポーネントデータ取得
- Supabase基本SELECT
- 合計金額算出
- リスト表示構造化

## 課題A：カート一覧取得関数を作る（7分）

7分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

カート行と関連する商品情報を取得する非公開関数を定義し取得基盤を用意する。

- 対象ファイル: `src/app/cart/page.tsx`（既存編集）
- 新規関数: `getCartItems()` を同ファイル内に定義（外部公開しない）
- 取得テーブル: `cart_items`
- 利用カラム: `id`（行ID）`quantity`（数量）リレーション`products(id, name, price)`（商品ID/商品名/価格）
- 抽出条件: `temp_user_id` が文字列 `demo-user` と等しい行のみ
- 並び順: `created_at` を昇順（古い順）
- 戻り値: 配列。取得結果がnullの場合は呼び出し側で空配列に置き換える（例: `items = data || []`）
- エラー: 取得失敗時は例外を投げる
- UI表示: 本課題では件数の行のみ表示（見出し下に1行）
- 合計計算: 未実装（次課題で追加）
- 禁止: 更新/削除/注文確定など後続機能のフォームやボタン追加

【使用タグ】
- `div`（最上位コンテナー）
  - `h1`（見出し: カート）
  - `p`（件数表示: "項目数: <数>"）

【命名】
- 関数: `getCartItems`（取得関数）`CartPage`（ページ関数）
- 変数: `data`（生取得結果）`items`（null対策後の配列）`total`（次課題で導入予定・本課題未使用）
- その他: 追加命名なし

【参照】
- 識別子: `createClient`（Supabaseクライアント生成）`dynamic`（動的キャッシュ指定`'force-dynamic'`）

### ヒント

- リレーション選択: `.select('id, quantity, products(id, name, price)')`
- 空配列対策: `const items = data || []`
- 件数表示: `items.length`

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  try {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('cart_items')
      .select('id, quantity, products(id, name, price)')
      .eq('temp_user_id', 'demo-user')
      .order('created_at');
    if (error) throw error;
    return data;
  } catch (e) {
    throw e;
  }
}

export default async function CartPage() {
  const data = await getCartItems();
  const items = data || [];
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">カート</h1>
      <p className="text-sm">項目数: {items.length}</p>
    </div>
  );
}
```

## 課題B：カート一覧UIを作る（9分）

9分ほどヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

取得データを用いて商品名・価格・数量と合計金額を表示する一覧UIを実装する。

- 対象ファイル: `src/app/cart/page.tsx`（既存編集）
- 再利用関数: `getCartItems`
- 合計計算: 配列を先頭から走査し各商品の（価格が未定義なら0）×数量を加算した総和を算出し数値 `total` に格納
- 表示要素: 見出し / 合計金額行 / 商品一覧または空メッセージ
- 商品行内容: 商品名 / 価格 / 数量
- 空時表示: 件数が0なら「カートは空です」を1行表示
- 並び順: 見出し → 合計金額行 → 一覧（または空メッセージ）
- 通貨表記: 価格と合計はいずれも先頭に `¥` を付け整数表示
- スタイル意図: コンテナー縦方向に適度な余白（約16px刻み）/ 商品行は枠線と内側余白で区切る / 見出しはやや大きめ太字 / 副情報テキストは小さめ灰色
- 余計なラッパー禁止: 仕様にない入れ子用`div`を追加しない
- 禁止: 更新/数量変更/削除/注文確定など後続課題のフォームやボタン追加

【使用タグ】
- `div`（最上位）
  - `h1`（タイトル: カート）
  - `p`（合計金額: "合計: ¥<金額>")
  - `ul`（商品一覧）
    - `li`（商品行）
      - `p`（商品名）
      - `p`（価格）
      - `p`（数量: "数量: <数>")
    - `p`（空時メッセージ: 件数0のときのみ）

【命名】
- 関数: `getCartItems` `CartPage`
- 変数: `data` `items` `total`
- その他: 追加命名なし

【参照】
- 識別子: `createClient` `dynamic`

### ヒント

- 合計: `(価格が未定義なら0) × 数量 を全行で加算`
- 数量表示: `item.quantity` をそのまま
- 空判定: 件数が0なら空メッセージ行のみ表示

### 解答例

```tsx
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

async function getCartItems() {
  try {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('cart_items')
      .select('id, quantity, products(id, name, price)')
      .eq('temp_user_id', 'demo-user')
      .order('created_at');
    if (error) throw error;
    return data;
  } catch (e) {
    throw e;
  }
}

export default async function CartPage() {
  const data = await getCartItems();
  const items = data || [];
  const total = items.reduce((sum, item) => sum + (item.products?.price || 0) * item.quantity, 0);
  return (
    <div className="space-y-4">
      <h1 className="text-lg font-bold text-pink-600">カート</h1>
      <p className="text-sm">合計: ¥{total}</p>
      {!items.length && <p className="text-sm text-gray-500">カートは空です</p>}
      <ul className="space-y-3">
        {items.map((item) => (
          <li key={item.id} className="border p-3 rounded space-y-2">
            <p className="text-sm font-semibold">{item.products?.name}</p>
            <p className="text-xs text-gray-500">¥{item.products?.price}</p>
            <p className="text-xs text-gray-500">数量: {item.quantity}</p>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

## 章末の確認

- 商品名 / 価格 / 数量が一覧表示される
- 合計金額が各（価格×数量）の総和になる
- 空時に「カートは空です」が1行表示される
- 件数0→1追加後に表示が変わる（再読み込み後も維持）
- 価格と合計は `¥` プレフィックス付き

```bash
npm run dev
```
