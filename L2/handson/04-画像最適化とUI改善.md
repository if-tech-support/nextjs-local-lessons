# 04-画像最適化とUI改善

## はじめに

この章では、Next.jsの`next/image`コンポーネントを使って画像の最適化を行い、UIを改善していきます。外部画像の表示、レスポンシブ対応、パフォーマンス向上を実現しましょう。

## 目的

next/imageで外部画像を最適化して表示する

## 学習対象のスキル

- `next/image`コンポーネントの使用方法
- 画像の最適化とレスポンシブ対応
- UIの改善とユーザビリティの向上

## 課題A：ユーザ一覧ページへのアバター画像の追加

（目安：20分）ヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`src/app/users/page.tsx`を編集し、以下の要件を満たしてください：

- 各ユーザ項目にアバター画像を追加
- 画像は`https://robohash.org/{id}`から取得（`{id}`はユーザID）
- `next/image`コンポーネントを使用して画像を最適化
- 画像サイズは128x128ピクセル
- 画像は円形で表示し、ユーザ情報の左側に配置
- 画像の読み込み中は適切なプレースホルダーを表示
- 画像の読み込みエラー時は適切なフォールバックを表示

### ヒント

- `next/image`をインポート
- `Image`コンポーネントで画像を表示
- `width`と`height`プロパティでサイズを指定
- `className`で円形スタイルを適用
- `alt`属性でアクセシビリティを向上
- Tailwindクラス：`w-32`、`h-32`、`rounded-full`、`object-cover`

### 解答例

```tsx:src/app/users/page.tsx
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';

interface User {
  id: number;
  name: string;
  company: {
    name: string;
  };
}

export default function UsersPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const response = await fetch('https://jsonplaceholder.typicode.com/users');
        if (!response.ok) {
          throw new Error('データの取得に失敗しました');
        }
        const data = await response.json();
        setUsers(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'エラーが発生しました');
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <p>読み込み中...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto p-6">
        <p>{error}</p>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ユーザ一覧</h1>
      <ul className="space-y-4">
        {users.map((user) => (
          <li key={user.id} className="border rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
            <Link href={`/users/${user.id}`} className="block">
              <div className="flex items-center space-x-6">
                <div className="relative">
                  <Image
                    src={`https://robohash.org/${user.id}`}
                    alt={`${user.name}のアバター`}
                    width={128}
                    height={128}
                    className="w-32 h-32 rounded-full object-cover border-2 border-gray-200"
                    onError={(e) => {
                      const target = e.target as HTMLImageElement;
                      target.src = '/placeholder-avatar.png';
                    }}
                  />
                </div>
                <div className="flex-1">
                  <span className="text-gray-500 text-sm">ID: {user.id}</span>
                  <h3 className="text-lg font-semibold text-gray-800 mt-1">{user.name}</h3>
                  <p className="text-gray-600 mt-1">{user.company.name}</p>
                </div>
              </div>
            </Link>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### 実装ポイント

- `next/image`で画像の最適化とパフォーマンス向上を実現
- 適切な`alt`属性でアクセシビリティを確保
- エラーハンドリングでフォールバック画像を表示
- レスポンシブ対応とホバー効果でUXを向上

## 課題B：ユーザ詳細ページへのアバター画像の追加

（目安：15分）ヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`src/app/users/[id]/page.tsx`を編集し、以下の要件を満たしてください：

- ユーザ詳細情報の上部にアバター画像を追加
- 画像は`https://robohash.org/{id}`から取得
- `next/image`コンポーネントを使用
- 画像サイズは128x128ピクセル
- 画像は円形で表示し、ユーザ名の左側に配置
- 画像とユーザ情報を横並びで配置

### ヒント

- `next/image`をインポート
- `Image`コンポーネントで画像を表示
- `width`と`height`プロパティでサイズを指定
- `className`で円形スタイルを適用
- Tailwindクラス：`w-32`、`h-32`、`rounded-full`、`object-cover`、`flex`、`items-center`

### 解答例

```tsx:src/app/users/[id]/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import BackButton from './BackButton';

// ... existing code ...

export default function UserDetailPage({ params }: PageProps) {
  // ... existing code ...

  return (
    <div className="max-w-2xl mx-auto p-6">
      <BackButton />
      <h1 className="text-3xl font-bold mb-6">ユーザ詳細</h1>
      <div className="bg-white rounded-lg shadow-md p-6 space-y-6">
        <div className="flex items-center space-x-6">
          <div className="relative">
            <Image
              src={`https://robohash.org/${user.id}`}
              alt={`${user.name}のアバター`}
              width={128}
              height={128}
              className="w-32 h-32 rounded-full object-cover border-2 border-gray-200"
            />
          </div>
          <div>
            <h2 className="text-2xl font-semibold text-gray-800">{user.name}</h2>
          </div>
        </div>
        
        <div className="space-y-3">
          <p className="text-gray-600">
            <span className="font-medium">メール:</span> {user.email}
          </p>
          <p className="text-gray-600">
            <span className="font-medium">会社:</span> {user.company.name}
          </p>
          <p className="text-gray-600">
            <span className="font-medium">ウェブサイト:</span>{' '}
            <a 
              href={`https://${user.website}`} 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-600 hover:text-blue-800 underline"
            >
              {user.website}
            </a>
          </p>
        </div>
      </div>
      
      <div className="mt-6 text-center">
        <button
          onClick={handleGoToList}
          className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors duration-200 font-medium"
        >
          ユーザ一覧に戻る
        </button>
      </div>
    </div>
  );
}
```

### 実装ポイント

- 画像とユーザ情報を適切にレイアウト
- 一貫したスタイリングでUIの統一感を保つ
- レスポンシブ対応とアクセシビリティの向上

## 課題C：next.config.jsでの画像最適化設定

（目安：10分）ヒントを参考にして仕様どおりにコーディングに挑戦し、その後に解答例で確認しましょう。

### 仕様

`next.config.ts`を編集し、以下の要件を満たしてください：

- `images.remotePatterns`で外部画像ドメインを許可
- `robohash.org`ドメインからの画像を許可
- `jsonplaceholder.typicode.com`ドメインからの画像を許可
- 適切なセキュリティ設定を維持

### ヒント

- `next.config.ts`で画像の最適化設定を追加
- `remotePatterns`で許可するドメインを指定
- セキュリティを考慮した適切な設定を行う

### 解答例

```ts:next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'robohash.org',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'jsonplaceholder.typicode.com',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
```

### 実装ポイント

- 外部画像ドメインの適切な許可設定
- セキュリティを考慮した最小限の設定
- パフォーマンスとセキュリティのバランス

## 章末の確認

以下の手順で動作確認を行ってください：

1. 開発サーバーを再起動（設定変更のため）
```bash
npm run dev
```

2. ブラウザで`http://localhost:3000/users`にアクセス

3. 確認項目
- ユーザ一覧ページで各ユーザにアバター画像が表示される
- アバター画像が128x128ピクセルの円形で表示される
- 画像が適切に最適化され、読み込みが高速である
- ユーザ詳細ページでもアバター画像が表示される
- 画像の読み込みエラー時は適切なフォールバックが表示される
- レスポンシブ対応が適切に動作する
- 全体的なUIが改善され、見た目が向上している
